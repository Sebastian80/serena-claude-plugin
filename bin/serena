#!/bin/bash
# Serena CLI - routes commands to MCP server via bridge
# Auto-discovers all tools from Serena MCP server

set -e

PLUGIN_DIR="$(dirname "$(dirname "$(realpath "$0")")")"
BRIDGE_VENV="${BRIDGE_VENV:-$HOME/.claude/plugins/marketplaces/sebastian-marketplace/plugins/ai-tool-bridge/.venv}"
CLAUDE_SETTINGS="$HOME/.claude/settings.local.json"

# Add permission to Claude settings if not present
add_claude_permission() {
    local perm="$1"

    if ! command -v jq &>/dev/null; then
        echo "Note: jq not found, skipping permission setup" >&2
        return
    fi

    if [[ ! -f "$CLAUDE_SETTINGS" ]]; then
        mkdir -p "$(dirname "$CLAUDE_SETTINGS")"
        echo '{"permissions":{"allow":[],"deny":[],"ask":[]}}' > "$CLAUDE_SETTINGS"
    fi

    if jq -e ".permissions.allow | index(\"$perm\")" "$CLAUDE_SETTINGS" &>/dev/null; then
        return
    fi

    local tmp=$(mktemp)
    if jq ".permissions.allow += [\"$perm\"]" "$CLAUDE_SETTINGS" > "$tmp"; then
        mv "$tmp" "$CLAUDE_SETTINGS"
        echo "Added Claude permission: $perm" >&2
    else
        rm -f "$tmp"
    fi
}

# Handle setup command
if [[ "$1" == "setup" ]]; then
    echo "Setting up Serena CLI..." >&2

    # Create symlink in ~/.local/bin
    LOCAL_BIN="$HOME/.local/bin"
    SERENA_LINK="$LOCAL_BIN/serena"
    SERENA_BIN="$PLUGIN_DIR/bin/serena"

    if [[ ! -L "$SERENA_LINK" ]] || [[ "$(readlink "$SERENA_LINK")" != "$SERENA_BIN" ]]; then
        mkdir -p "$LOCAL_BIN"
        ln -sf "$SERENA_BIN" "$SERENA_LINK"
        echo "Created symlink: serena -> $SERENA_BIN" >&2
    fi

    # Add Claude permission
    add_claude_permission 'Bash(serena:*)'

    echo "Serena CLI ready." >&2
    exit 0
fi

# Route all commands through bridge
exec "$BRIDGE_VENV/bin/bridge" serena "$@"
