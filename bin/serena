#!/bin/bash
# Serena CLI wrapper with auto-setup
# Automatically creates venv and installs package on first use

set -e

PLUGIN_DIR="$(dirname "$(dirname "$(realpath "$0")")")"
VENV_DIR="$PLUGIN_DIR/.venv"
SERENA_BIN="$VENV_DIR/bin/serena"
CLAUDE_SETTINGS="$HOME/.claude/settings.local.json"

# Add permission to Claude settings if not present
add_claude_permission() {
    local perm="$1"

    if ! command -v jq &>/dev/null; then
        echo "Note: jq not found, skipping permission setup" >&2
        return
    fi

    if [[ ! -f "$CLAUDE_SETTINGS" ]]; then
        mkdir -p "$(dirname "$CLAUDE_SETTINGS")"
        echo '{"permissions":{"allow":[],"deny":[],"ask":[]}}' > "$CLAUDE_SETTINGS"
    fi

    if jq -e ".permissions.allow | index(\"$perm\")" "$CLAUDE_SETTINGS" &>/dev/null; then
        return
    fi

    local tmp=$(mktemp)
    if jq ".permissions.allow += [\"$perm\"]" "$CLAUDE_SETTINGS" > "$tmp"; then
        mv "$tmp" "$CLAUDE_SETTINGS"
        echo "Added Claude permission: $perm" >&2
    else
        rm -f "$tmp"
    fi
}

# Auto-setup: Create venv and install if needed
setup_venv() {
    echo "Setting up Serena..." >&2

    # Create venv if it doesn't exist
    if [[ ! -d "$VENV_DIR" ]]; then
        echo "Creating Python virtual environment..." >&2
        python3 -m venv "$VENV_DIR"
    fi

    # Install/upgrade package
    echo "Installing serena package..." >&2
    "$VENV_DIR/bin/pip" install --quiet --upgrade pip
    "$VENV_DIR/bin/pip" install --quiet -e "$PLUGIN_DIR"

    # Create symlink in ~/.local/bin for clean CLI access
    LOCAL_BIN="$HOME/.local/bin"
    SERENA_LINK="$LOCAL_BIN/serena"
    if [[ ! -L "$SERENA_LINK" ]] || [[ "$(readlink "$SERENA_LINK")" != "$SERENA_BIN" ]]; then
        mkdir -p "$LOCAL_BIN"
        ln -sf "$SERENA_BIN" "$SERENA_LINK"
        echo "Created symlink: serena -> $SERENA_BIN" >&2
    fi

    # Add Claude permission
    add_claude_permission 'Bash(serena:*)'

    echo "Setup complete." >&2
}

# Check if serena is installed and working
if [[ ! -x "$SERENA_BIN" ]]; then
    setup_venv
fi

# Handle setup command explicitly
if [[ "$1" == "setup" ]]; then
    setup_venv
    echo "Serena is ready."
    exit 0
fi

# Execute serena command
exec "$SERENA_BIN" "$@"
